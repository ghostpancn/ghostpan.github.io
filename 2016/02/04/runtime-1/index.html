<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Objective-C Runtime 初识（一） · Ghostpan's blog</title><meta name="description" content="Objective-C Runtime 初识（一） - Ghostpan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/tiger_head_round.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.ghostpan.com/atom.xml" title="Ghostpan's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/flat_red_ghostpan.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ghostpancn" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Objective-C Runtime 初识（一）</h1><div class="post-info">Feb 4, 2016</div><div class="post-content"><p>平时也有了解一些 Runtime 相关的知识，但都是只处于知道阶段没有详细了解过，最近没有那么忙了准备抽个时间来边学边记录一下。</p>
<a id="more"></a>
<h3 id="初识"><a href="#初识" class="headerlink" title="初识"></a>初识</h3><p>Runtime 字面意思运行时，是一个将 C 语言转化为面向对象语言的扩展，是 Objective-C 被称之为动态语言的核心。</p>
<p>在 C 语言中函数的调用在编译期就已经确定，而在 Objective-C 中在编译期内无法确定具体调用哪个函数，只有在真正运行的时候才确定调用。</p>
<p>本篇博客具体记录基于 objc2.0 对象在 Runtime 中的定义。</p>
<h3 id="objc-class"><a href="#objc-class" class="headerlink" title="objc_class"></a>objc_class</h3><p>objc2.0 之后的 objc_class 定义如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    class_data_bits_t bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码可以得出：</p>
<ul>
<li>Objective-C 的对象都是 C 语言结构体</li>
<li><code>id</code> 是指向 <code>struct objc_object</code> 的一个指针</li>
<li><code>class</code> 是指向 <code>objc_class</code> 的指针</li>
<li><code>objc_class</code> 继承于 `objc_object</li>
</ul>
<h3 id="isa-amp-superclass"><a href="#isa-amp-superclass" class="headerlink" title="isa &amp; superclass"></a>isa &amp; superclass</h3><p>isa 是一个 <code>isa_t</code> 的结构体，它包含了当前对象指向的类的信息。</p>
<ul>
<li>对象中的 isa 指向它的类对象</li>
<li>类对象中的 isa 指向它的元类对象</li>
</ul>
<p>superclass 指向它的父类对象。</p>
<p>对应关系图如下：</p>
<p><img src="/images/class diagram.png" alt="class diagram"></p>
<p>类对象的 isa 指向一个 <code>meta class</code> 元类，所有元类的 isa 都指向了 <code>Root class (meta)</code> ，而 <code>Root class (meta)</code> 是 <code>Root class (class)</code> 的子类，即 NSObject / NSProxy 的子类。</p>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><p>cache 用于方法性能优化，每次发送消息时，优先在 cache 中查找，查找不到的情况下去类和它的父类方法列表中查找，找不到的情况下消息转发，找到之后会将方法缓存在 cache 中。</p>
<p>找到 cache_t 结构体的具体实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cache_t &#123;  </span><br><span class="line">    <span class="keyword">struct</span> bucket_t *_buckets;</span><br><span class="line">    mask_t _mask;</span><br><span class="line">    mask_t _occupied;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> uint32_t;  </span><br><span class="line"><span class="keyword">typedef</span> uint32_t mask_t;  <span class="comment">// x86_64 &amp; arm64 asm are less efficient with 16-bits</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span>  uintptr_t;  </span><br><span class="line"><span class="keyword">typedef</span> uintptr_t cache_key_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> bucket_t &#123;  </span><br><span class="line">private:  </span><br><span class="line">    cache_key_t _key;</span><br><span class="line">    IMP _imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>_buckets 是一个散列表，用来做方法缓存</li>
<li>_mask 分配可以缓存的 <code>bucket_t</code> 总数</li>
<li>_occupied 实际占用缓存的 <code>bucket_t</code> 个数</li>
</ul>
<h3 id="bits"><a href="#bits" class="headerlink" title="bits"></a>bits</h3><p><code>class_data_bits_t</code> 源码实现如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> class_data_bits_t &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Values are the FAST_ flags above.</span></span><br><span class="line">    uintptr_t bits;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_rw_t &#123;  </span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> class_ro_t *ro;</span><br><span class="line"></span><br><span class="line">    method_array_t methods;</span><br><span class="line">    property_array_t properties;</span><br><span class="line">    protocol_array_t protocols;</span><br><span class="line"></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *demangledName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_ro_t &#123;  </span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    uint32_t reserved;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</span><br><span class="line">    method_list_t * baseMethodList;</span><br><span class="line">    protocol_list_t * baseProtocols;</span><br><span class="line">    <span class="keyword">const</span> ivar_list_t * ivars;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties;</span><br><span class="line"></span><br><span class="line">    method_list_t *baseMethods() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> baseMethodList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>class_rw_t</code> 中存放类的属性列表、方法列表、遵循的协议列表、只读的 <code>class_ro_t</code> 等，它提供了运行时对类进行扩展的能力。</p>
<p><code>class_ro_t</code> 存储的信息基本都是编译时就已经可以确定的信息，在编译之后不做修改。</p>
<p>类初始化之前 <code>objc_class-&gt;data()</code> 返回的指针指向的是一个 <code>class_ro_t</code> 结构体，初始化时类调用 <code>realizeClass</code> 静态方法，开辟一个 <code>class_rw_t</code> 的空间，并把 <code>class_ro_t</code> 指针赋值给 <code>class_rw_t-&gt;ro</code> ，具体实现细节有时间在仔细研究研究。。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h3><ul>
<li><a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="noopener">Objective-C Runtime</a></li>
<li><a href="http://southpeak.github.io/2014/10/25/objective-c-runtime-1/" target="_blank" rel="noopener">Objective-C Runtime 运行时之一：类与对象</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2016/02/24/runtime-2/" class="prev">PREV</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2016/02/04/runtime-1/';
var disqus_title = 'Objective-C Runtime 初识（一）';
var disqus_url = 'http://blog.ghostpan.com/2016/02/04/runtime-1/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://blog.ghostpan.com">Ghostpan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>